<!DOCTYPE html>
<!--

　 | ￣￣￣￣￣￣￣|
　 |　 欢迎偷窥  　|
／33______________ Ε~ ヽ、
/ ノ)　　　　　　　　 ） ヽ
/ ｜ 　(′?ω?‘)ノ⌒（ゝ._ノ
/   /⌒7⌒ヽーく　 ＼　／
丶＿ ノ 　ノ*** |/***
  `ヽ `ー-'′_人`ー'/
    丶 ￣ _人'彡/
　    / 　r'十ヽ/


Qist Chan

mail：	mail@chenyuqi.cn
weibo:	weibo.com/523690252

2014~2015 © QistChan.com

───────────────────────────────────────────────────────────
─██████████████───██████████─██████████████─██████████████─
─██          ██───██      ██─██          ██─██          ██─
─██  ██████  ██───████  ████─██  ██████████─██████  ██████─
─██  ██──██  ██─────██  ██───██  ██─────────────██  ██─────
─██  ██──██  ██─────██  ██───██  ██████████─────██  ██─────
─██  ██──██  ██─────██  ██───██          ██─────██  ██─────
─██  ██──██  ██─────██  ██───██████████  ██─────██  ██─────
─██  ██──██  ██─────██  ██───────────██  ██─────██  ██─────
─██  ██████  ████─████  ████─██████████  ██─────██  ██─────
─██            ██─██      ██─██          ██─────██  ██─────
─████████████████─██████████─██████████████─────██████─────
───────────────────────────────────────────────────────────
-->
<html>
<head>
  <meta charset="UTF-8">
  <meta name="baidu_union_verify" content="56127d6dc6b67511bc57c2290addb470">
  
  <title>Nginx部署全站SSL - 浮风</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="/favicon.ico" />
  
    <link rel="alternative" href="/atom.xml" title="浮风" type="application/atom+xml">
  
  <!--[if lt IE 9]>
    <script type="text/javascript" src="//dn-qistchan-cdn.qbox.me/html5.js"></script>
    <script type="text/javascript" src="//dn-qistchan-cdn.qbox.me/css3-mediaqueries.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="//dn-qistchan-cdn.qbox.me/style.css">
  <link rel="stylesheet" href="//dn-qistchan-cdn.qbox.me/highlight.css">
  <link rel="stylesheet" href="//dn-qistchan-cdn.qbox.me/links.css">
  <link rel="stylesheet" href="//dn-qistchan-cdn.qbox.me/mobie_nav.css">
  <!--百度统计-->
  <script>
	var _hmt = _hmt || [];
	(function() {
	var hm = document.createElement("script");
	hm.src = "//hm.baidu.com/hm.js?53c020181e3fdecad7414e11b9ba5453";
	var s = document.getElementsByTagName("script")[0]; 
	s.parentNode.insertBefore(hm, s);
	})();
</script>
</head>
<body>
    <header id="header">
    <div class="nav-warp">
      <div id="nav_pc" class="w">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/tsukkomi">Tsukkomi</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
          <a class="main-nav-link" href="/categories/Episodes">Episodes</a>
        
          <a class="main-nav-link" href="/categories/Annals">Annals</a>
        
          <a class="main-nav-link" href="/categories/Lab">Labs</a>
        
          <a class="main-nav-link" href="/#footer">Links</a>
        
		
        <a id="nav-search" class="icon-search fr" onclick="show_search()" title="搜索"></a>
        <div id="nav-search-input" class="hide">
          <form class="search-form" onsubmit="return dispatch()">
            <input type="hidden" id="site" value="site:http://qistchan.com">
            <input type="text" id="q" class="input-text" name="q" placeholder="搜索">
            <input type="submit" value="" class="input-submit">
          </form>
        </div>
      </nav>
    </div>
		
		<nav style="display:none">
		<ul>
		
			<li><a href="/">Home</a></li>
		
			<li><a href="/tsukkomi">Tsukkomi</a></li>
		
			<li><a href="/archives">Archives</a></li>
		
			<li><a href="/about">About</a></li>
		
			<li><a href="/categories/Episodes">Episodes</a></li>
		
			<li><a href="/categories/Annals">Annals</a></li>
		
			<li><a href="/categories/Lab">Labs</a></li>
		
			<li><a href="/#footer">Links</a></li>
		
		</ul>
		</nav>
	
    <div id="logo">
      <div class="hg">
      
        <h2 id="site-title">
		  <img src="//dn-qistchan.qbox.me/logo.png" width="192" height="96" />
		  <br/>
		  <img src="//dn-qistchan.qbox.me/text.png" width="256" height="35" />
        </h2>
        
          
        
      
      </div>
    </div>
	<script src="//dn-qistchan-cdn.qbox.me/jquery.min.js"></script>
  </header>
  <section id="main"><article class="post">
  <header class="post-head">
    
  
    
      <h1 class="post-title">Nginx部署全站SSL</h1>
    
  

    
<time datetime="2015-04-05T11:04:48.000Z" class="post-time">2015-04-05</time>

  </header>
  
      <section class="post-images">
        <a href="/2015/04/05/Nginx部署全站SSL/">
          <img src="https://dn-qistchan.qbox.me/image/20150405-SSL/00.jpg" alt="featured-image">
        </a>
      </section>
  
  <section class="post-content typo">
    <p>#Nginx部署全站SSL</p>
<p>###——又好又实惠的SSL证书部署</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在先前的文章（全民HTTPS时代的来临）中，我提到了越来越多的网站用户开始注重自己的网络信息安全，加上最近CNNIC的证书也是闹得沸沸扬扬。我也赶着时髦般给自己的站点加上了全站SSL，下面我来介绍一下我自己的配置经历。</p>
<a id="more"></a>
<p>####1 购买 SSL 证书之前的准备</p>
<p>#####1.1 生成私钥</p>
<p>我们这里准备将证书文件安装在 <code>/root</code> 下</p>
<p>使用XShell连接VPS，输入如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root</span><br><span class="line">openssl genrsa -out ssl.key <span class="number">2048</span></span><br></pre></td></tr></table></figure>
<p>这样就生成了私钥 <code>ssl.key</code> </p>
<p>#####1.2 生成证书请求文件</p>
<p>我们来继续步骤，生成证书请求文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -key ssl.key -out ssl.csr</span><br></pre></td></tr></table></figure>
<p>请注意，在生成证书请求文件文件的时候请按照提示填写你的基本信息！（国别：CN，省，市，公司名称，组织名称，网址，邮箱）</p>
<p>这样就生成了证书请求文件 <code>ssl.csr</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat ssl.csr</span><br></pre></td></tr></table></figure>
<p>这里把显示的内容复制下来备用！</p>
<p>####2 购买 / 申请 SSL 证书<br>有了证书请求文件 <code>ssl.csr</code>之后我们就可以来购买 SSL证书了</p>
<p>#####2.1 证书推荐</p>
<p>免费的SSL证书有StartSSL和沃通SSL，这两种的申请方法网上已经有了很多了，这里就不再赘述。</p>
<p>我在这里推荐两个收费的SSL证书，都是比较便宜的，适合个人网站：</p>
<p>（1）Comodo Positive SSL 约 40 RMB/Year</p>
<p>（2）RapidSSL Standard SSL 约 80 RMB/Year</p>
<p>至于购买的网址，推荐 Namecheap 和 RubySSL ， 前者是国外知名的IDC，后者则是国人建立的销售网站，价格也差不多；</p>
<p>#####2.2 证书购买<br>其实证书购买的过程基本都大同小异<br>我们这里以RubySSL的购买方法来讲解<br>（1）购买SSL，这个没得说，拍下付款就行了，支持支付宝；<br>（2）申请证书；<br>在账户中点击已经购买的证书，就可以开始配置证书了；</p>
<p>首先我们见到的是这样的界面，将刚刚复制的<code>ssl.csr</code>的内容粘贴在文本框中，同时服务器类型选择其他；</p>
<p><img src="https://dn-qistchan.qbox.me/image/20150405-SSL/1.png" alt=""></p>
<p>下面网站会要求验证域名的所有权，选择它提供的和域名注册时候填写的相符合的邮箱，或者该域名的管理员域名邮箱，你将会接收到一份验证邮件；</p>
<p><img src="https://dn-qistchan.qbox.me/image/20150405-SSL/2.png" alt=""></p>
<p>接收到验证邮件之后，复制验证码，并点击Here进入验证页面；</p>
<p><img src="https://dn-qistchan.qbox.me/image/20150405-SSL/3.png" alt=""></p>
<p>在弹出的页面中输入验证码，点击继续，就完成了证书的申请！</p>
<p><img src="https://dn-qistchan.qbox.me/image/20150405-SSL/4.png" alt=""></p>
<p>接下来我们要做的就是耐心等待邮件！</p>
<p>####3 Nginx环境下部署 SSL</p>
<p>#####3.1 证书的预配置</p>
<p>我们接受到的Comodo的证书会提供给你三个证书文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AddTrustExternalCARoot.crt 根证书</span><br><span class="line">PositiveSSLCA2.crt 中级证书</span><br><span class="line">www_xxx_com.crt 自己的证书</span><br></pre></td></tr></table></figure>
<p>我们需要将这三个证书整合为一个，使用Notepad++或者其他文本工具打开3个证书文件， 把<code>PositiveSSLCA2.crt</code>和<code>AddTrustExternalCARoot.crt</code>的内容追加到<code>www_xxx_com.crt</code>证书的后面!</p>
<p>将整合完的证书命名为<code>ssl.crt</code>并上传到<code>/root</code>目录(推荐使用<code>XFtp</code>)</p>
<p>#####3.2 证书的安装</p>
<p>使用 <code>vi</code> 打开你的域名的conf文件（LNMP的在 <code>/usr/local/nginx/conf/vhost/</code>下）</p>
<p>在<code>server {</code>改为如下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">listen <span class="number">443</span>;</span><br><span class="line">listen <span class="number">80</span>;</span><br><span class="line">server_name 你的域名；</span><br><span class="line">ssl on;</span><br><span class="line">ssl_certificate /root/ssl.crt;</span><br><span class="line">ssl_certificate_key /root/ssl.key;</span><br><span class="line">ssl_session_timeout <span class="number">5</span>m;</span><br><span class="line">ssl_protocols SSLv2 SSLv3 TLSv1;</span><br><span class="line">ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;</span><br><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line">以下下的内容不变</span><br></pre></td></tr></table></figure>
<p>重新启动Nginx服务，使用https访问你的域名，看是不是能访问了！</p>
<p>####4 Tips 1 - 强制HTTP跳转HTTPS</p>
<p>由于现在的人一般都比较懒，所以很多人访问网址的时候总是不喜欢输入http或者https，所以我们需要自动跳转https！</p>
<p>还是修改相应的conf，修改为类似如下的内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">listen <span class="number">443</span>;</span><br><span class="line">server_name 你的域名；</span><br><span class="line">ssl on;</span><br><span class="line">ssl_certificate /root/ssl.crt;</span><br><span class="line">ssl_certificate_key /root/ssl.key;</span><br><span class="line">ssl_session_timeout <span class="number">5</span>m;</span><br><span class="line">ssl_protocols SSLv2 SSLv3 TLSv1;</span><br><span class="line">ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;</span><br><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line">以下省略</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<p>然后再添加如下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">listen <span class="number">80</span>;</span><br><span class="line">server_name 你的域名；</span><br><span class="line">rewrite ^(.*)$  https://<span class="variable">$host</span><span class="variable">$1</span> permanent;</span><br><span class="line">以下省略(复制上面的省略部分)</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<p>重新启动Nginx服务，使用http访问你的域名，看是不是能自动跳转了！</p>
<p>####5 Tips 2 - 百度蜘蛛的优化</p>
<p>由于百度蜘蛛对https网站的支持不是很好，所以我们需要对百度蜘蛛做一个例外，将80端口的conf按照如下配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">listen <span class="number">80</span>;</span><br><span class="line">server_name 你的域名；</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_user_agent</span> !~* Baidu)</span><br><span class="line">		&#123;</span><br><span class="line">			rewrite ^(.*)$  https://<span class="variable">$host</span><span class="variable">$1</span> permanent;</span><br><span class="line">		｝</span><br><span class="line">以下省略(复制上面的省略部分)</span><br><span class="line">｝</span><br></pre></td></tr></table></figure>
<p>至此，我们的全站SSL就完全配置完毕了！</p>

  </section>
  
  <footer class="post-foot">
    <section class="post-foot-warp clear">
      
  <ul class="post-tag icon-tag fl">
    
      <li><a href="/tags/Comodo/">#Comodo</a></li>
    
      <li><a href="/tags/Nginx/">#Nginx</a></li>
    
      <li><a href="/tags/SSL/">#SSL</a></li>
    
      <li><a href="/tags/https/">#https</a></li>
    
      <li><a href="/tags/全站SSL/">#全站SSL</a></li>
    
  </ul>

      
  <ul class="post-category icon-category fr">
    
      <li><a href="/categories/Lab/">Lab</a></li>
    
  </ul>

    </section>
  </footer>
  
</article>

    
<nav id="post-nav" class="clear">
  
    <a href="/2015/04/05/iloveppt-invites/" id="post-nav-newer" class="post-nav-link-wrap fl" title="我爱PPT中文网邀请码自助领取系统-新版（网页）">
      <div class="post-nav-title">&laquo; 我爱PPT中文网邀请码自助领取系统-新版（网页）</div>
    </a>
  
  
    <a href="/2015/03/29/Office365/" id="post-nav-older" class="post-nav-link-wrap fr" title="Office365教育版赠送计划">
      <div class="post-nav-title">Office365教育版赠送计划 &raquo;</div>
    </a>
  
</nav>



<section id="comments">
  <!-- 多说评论框 start -->
  <div class="ds-thread" data-thread-key="post-Nginx部署全站SSL" data-title="Nginx部署全站SSL" data-url="http://qistchan.com/2015/04/05/Nginx部署全站SSL/"></div>
  <!-- 多说评论框 end -->
</section>
</section>
    <footer id="footer">
    <div class="foot-warp">
	<div id="footerbig">
	<div style="width:100%; margin:0 auto; overflow:auto; _display:inline-block;"> 
    <div style="width:300px; float:right;">
	<img src="//dn-qistchan.qbox.me/image/2015-icon/link-12.png" width="10" height="10" />&nbsp&nbspLinks：<br/>
	<!--友情链接-->
	<section class="link-braces">
		<p>
		
		<a href="http://w1989.com">&nbsp<img src="//dn-qistchan.qbox.me/image/2015-icon/link-12.png" width="10" height="10" />&nbsp&nbsp隔壁老王&nbsp</a><br/>
		<a href="http://petite-dd.com/">&nbsp<img src="//dn-qistchan.qbox.me/image/2015-icon/link-12.png" width="10" height="10" />&nbsp&nbsppetite-dd&nbsp</a><br/>
		<a href="http://www.cuolove.com/">&nbsp<img src="//dn-qistchan.qbox.me/image/2015-icon/link-12.png" width="10" height="10" />&nbsp&nbsp错爱网&nbsp</a><br/>
		<a href="https://www.gehaowu.com">&nbsp<img src="//dn-qistchan.qbox.me/image/2015-icon/link-12.png" width="10" height="10" />&nbsp&nbsp葛豪武的个人网站&nbsp</a>
		</p>
		</section>
	</div> 
	<!--版权信息-->
	<div style=" margin-right:210px;">
	  <p><img src="//dn-qistchan.qbox.me/image/2015-icon/shield-12.png" width="10" height="10" />&nbsp&nbsp蜀ICP备14031543号-1</p>
	  <p>2014-2016 &copy; QistChan.com / <a href="http://kunr.me/">Theme by Kunr</a></p>
	  <!--运行时间-->
	  Steadily Run <span id="aa"></span>
		<SCRIPT language=javascript> 
		<!-- 
		//document.write(""); 
		function show_date_time(){ 
		window.setTimeout("show_date_time()", 1000); 
		timeold=((new Date()).getTime()-(new Date("12/25/2014 00:00:00")).getTime()); 
		sectimeold=timeold/1000 
		secondsold=Math.floor(sectimeold); 
		msPerDay=24*60*60*1000
		e_daysold=timeold/msPerDay 
		daysold=Math.floor(e_daysold); 
		e_hrsold=(e_daysold-daysold)*24; 
		hrsold=Math.floor(e_hrsold); 
		e_minsold=(e_hrsold-hrsold)*60; 
		minsold=Math.floor((e_hrsold-hrsold)*60); 
		seconds=Math.floor((e_minsold-minsold)*60); 
		aa.innerHTML=""+daysold+" Days "+hrsold+" Hours "+minsold+" Mins "+seconds+" Secs "; 
		} 
		show_date_time(); 
		//--> 
		</SCRIPT>
		<br/><br/>
	  <img src="//dn-qistchan.qbox.me/d-aliyun.png" width="55" height="16" />&nbsp;&nbsp;
	  <img src="//dn-qistchan.qbox.me/d-qiniu.png" width="55" height="16" />&nbsp;&nbsp;
	  <img src="//dn-qistchan.qbox.me/qimg.png" width="55" height="16" />&nbsp;&nbsp;
	  <img src="//dn-qistchan.qbox.me/ssl.png" width="50" height="32" />&nbsp;&nbsp;
    </div>
	</div>
	</div>
	<div id="footersmall">
		<p><img src="//dn-qistchan.qbox.me/image/2015-icon/shield-12.png" width="10" height="10" />&nbsp&nbsp蜀ICP备14031543号-1</p>
		<p>2014-2016 &copy; QistChan.com </p>
	</div>
	</div>
	<!--CNZZ-->
	<span style="display:none">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");
			document.write(unescape("%3Cspan id='cnzz_stat_icon_1000531559'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1000531559%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</span>
  </footer>

  <!--搜索和自适应部分-->
  
  <script src="//dn-qistchan-cdn.qbox.me/mobie_nav.js"></script>
  <script type="text/javascript">
	function show_search(){
		var search_input = document.getElementById('nav-search-input');
		if (search_input.className == 'show') {
		search_input.attributes.removeNamedItem('class');
		var class_name = document.createAttribute('class');
		class_name.value = 'hide';
		search_input.attributes.setNamedItem(class_name);
			} else {
				search_input.attributes.removeNamedItem('class');
				var class_name = document.createAttribute('class');
				class_name.value = 'show';
				search_input.attributes.setNamedItem(class_name);
			};
		}

	function dispatch() {
		var q = document.getElementById("q");
		var site = document.getElementById("site");
		if (q.value != "") {
			var url = 'https://www.baidu.com/s?wd=site:qistchan.com%20' + q.value;
			if (navigator.userAgent.indexOf('iPad') > -1 || navigator.userAgent.indexOf('iPhone') > -1 || navigator.userAgent.indexOf('iPhone') > -1) {
				location.href = url;
			} else {
				window.open(url, "_blank");
			}
			return false;
		} else {
			return false;
		}
	}
	var footer_resize=function(){
		var browser_width = $(window).width(); 
		if(browser_width<1024){
		$("#footerbig").hide();
		$("#footersmall").show();
		}else{
		$("#footerbig").show();
		$("#footersmall").hide();
		}
	}
	var comment_resize=function(){
		var browser_width = $(window).width(); 
		if(browser_width<700){
		$("#comments").hide();
		$("#post-nav").hide();
		}else{
		$("#comments").show();
		$("#post-nav").show();
		}
	}	
	var title_resize=function(){
		var browser_width = $(window).width(); 
		if(browser_width<950){
		$(".post-title").css("font-size","2em");
		$(".typo h1").css("font-size","1.8em");
		}else{
		$(".post-title").css("font-size","2.4em");
		$(".typo h1").css("font-size","2em");
		}
		if(browser_width<600){
		$(".post-title").css("font-size","1.8em");
		$(".typo h1").css("font-size","1.4em");
		}
		if(browser_width<400){
		$(".post-title").css("font-size","1.4em");
		$(".typo h1").css("font-size","1.2em");
		}
	}		
	var nav_resize=function(){
		var browser_width = $(window).width(); 
		if(browser_width<=624){
		$("#nav_pc").hide();
		}else{
		$("#nav_pc").show();
		}
	}		
	
	var my_resize=function(){
	footer_resize();
	comment_resize();
	title_resize();
	nav_resize();
	}
	my_resize();
	window.onresize=my_resize;
	jQuery(document).ready(function () {
		jQuery('header nav').meanmenu();
	});
  </script>
  <!--评论部分-->
  
  
  <!--搜索部分多说-->
  <script type="text/javascript">
    var duoshuoQuery = {short_name:'qistchan'};
      (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//dn-qistchan-cdn.qbox.me/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  
  
</body>
</html>